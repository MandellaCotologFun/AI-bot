import telebot
import os
import uuid
import numpy as np
from PIL import Image
import tensorflow as tf
from ECO_TOKEN import TG_TOKEN

bot = telebot.TeleBot(TG_TOKEN)

if not os.path.exists("images"):
    os.mkdir("images")

def get_class(model_path, labels_path, image_path):
    try:
        if not os.path.exists(model_path):
            return "–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
        if not os.path.exists(labels_path):
            return "–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –º–µ—Ç–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
        with open(labels_path, "r", encoding="utf-8") as f:
            labels = [line.strip() for line in f.readlines()]
        interpreter = tf.lite.Interpreter(model_path=model_path)
        interpreter.allocate_tensors()

        input_details = interpreter.get_input_details()
        output_details = interpreter.get_output_details()
        try:
            img = Image.open(image_path).convert("RGB")
        except:
            return "–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º."

        input_shape = input_details[0]["shape"]
        target_size = (input_shape[1], input_shape[2])
        img = img.resize(target_size)

        input_data = np.expand_dims(img, axis=0).astype(np.float32)
        input_data = input_data / 255.0 

        interpreter.set_tensor(input_details[0]["index"], input_data)
        interpreter.invoke()

        output_data = interpreter.get_tensor(output_details[0]["index"])
        predicted_id = np.argmax(output_data)

        if predicted_id < len(labels):
            return labels[predicted_id]
        else:
            return "–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å."

    except Exception as e:
        print("–û—à–∏–±–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞:", e)
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è."

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id, "‚âΩ^‚Ä¢ Àï ‚Ä¢ ‡æÄ‡Ω≤‚âº –ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚ô°")


@bot.message_handler(commands=['help'])
def help_message(message):
        bot.send_message(message.chat.id,
        "üõ† –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n"
        "/start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ‚ô°\n"
        "/help - –ü–æ–º–æ—â—å‚ô°\n"
        "/upload - –û—Ç–ø—Ä–∞–≤—å –∫–∞—Ä—Ç–∏–Ω–∫—É, –∞ —è –µ—ë —Å–æ—Ö—Ä–∞–Ω—é –∏ –æ–±—Ä–∞–±–æ—Ç–∞—é‚ô°\n"
    )


@bot.message_handler(commands=['upload'])
def ask_for_photo(message):
    bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∏ —è –µ—ë –æ–±—Ä–∞–±–æ—Ç–∞—é!")


@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    try:
        file_info = bot.get_file(message.photo[-1].file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        unique_name = str(uuid.uuid4()) + ".jpg"
        save_path = os.path.join("images", unique_name)

        with open(save_path, "wb") as new_file:
            new_file.write(downloaded_file)

        bot.send_message(message.chat.id, f"üì∏ –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n–ò–º—è —Ñ–∞–π–ª–∞: {unique_name}")

        model_path = "model/model.tflite"
        labels_path = "model/labels.txt"

        bot.send_message(message.chat.id, "üîé –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")

        result = get_class(model_path, labels_path, save_path)

        bot.send_message(message.chat.id, f"üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏: {result}")

    except Exception as e:
        bot.send_message(message.chat.id, "üòø –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")
        print("–û—à–∏–±–∫–∞:", e)

@bot.message_handler(content_types=['text'])
def warn_no_photo(message):
    if message.text == "/upload":
        return
    bot.send_message(message.chat.id, "–Ø –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ! üñº")

bot.infinity_polling()
